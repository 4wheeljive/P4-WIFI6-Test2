name: ESP32 QEMU Test (Merged-Bin)

on:
  pull_request:  # ONLY for PRs in this repo (security!)
    paths:
      - 'src/**'
      - 'examples/**'
      - 'ci/**'
      - '.github/workflows/qemu_tobozo2.yml'
      - '.github/workflows/qemu_template.yml'

permissions:
  contents: read
  pull-requests: read

jobs:
  qemu_test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [esp32dev, esp32s3, esp32c3]
        sketch: [Blink, BlinkParallel]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install dependencies
        run: |
          echo "=== Installing dependencies ==="
          uv sync
          uv pip install platformio esptool

          echo "=== Environment ==="
          python --version
          uv run pio --version

      - name: Build with merged binary
        run: |
          echo "=== Building ${{ matrix.sketch }} for ${{ matrix.platform }} ==="
          echo "Build command:"
          echo "  uv run ci/ci-compile.py ${{ matrix.platform }} --examples ${{ matrix.sketch }} --merged-bin -o qemu-build/merged.bin"

          set -x
          uv run ci/ci-compile.py ${{ matrix.platform }} \
            --examples ${{ matrix.sketch }} \
            --merged-bin \
            -o qemu-build/merged.bin \
            --defines FASTLED_ESP32_IS_QEMU \
            --verbose
          set +x

          echo "=== Build Complete ==="

      - name: Verify merged binary
        run: |
          echo "=== Binary Validation ==="

          if [ ! -f qemu-build/merged.bin ]; then
            echo "❌ Merged binary not found!"
            echo "Build directory contents:"
            ls -laR .build/${{ matrix.platform }} || true
            exit 1
          fi

          echo "✅ Merged binary exists"

          # Check size
          SIZE=$(stat -c%s qemu-build/merged.bin)
          echo "Binary size: $SIZE bytes"

          if [ $SIZE -lt 100000 ]; then
            echo "❌ Binary too small: $SIZE bytes"
            exit 1
          fi

          # Check ESP32 magic byte
          MAGIC=$(xxd -p -l 1 qemu-build/merged.bin)
          if [ "$MAGIC" = "e9" ]; then
            echo "✅ Valid ESP32 bootloader magic byte (0xE9)"
          else
            echo "❌ Invalid magic byte: 0x$MAGIC (expected 0xE9)"
            exit 1
          fi

          # Show hex dump
          echo "=== Binary Header (first 32 bytes) ==="
          xxd -l 32 qemu-build/merged.bin

          # MD5 checksum
          echo "=== Binary Checksum ==="
          md5sum qemu-build/merged.bin

      - name: Map platform to chip
        id: chip
        run: |
          case "${{ matrix.platform }}" in
            esp32dev|esp32wroom) echo "chip=esp32" >> $GITHUB_OUTPUT ;;
            esp32s3)             echo "chip=esp32s3" >> $GITHUB_OUTPUT ;;
            esp32c3)             echo "chip=esp32c3" >> $GITHUB_OUTPUT ;;
            *)                   echo "chip=esp32" >> $GITHUB_OUTPUT ;;
          esac
          echo "Mapped ${{ matrix.platform }} -> $(grep chip= $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Run QEMU
        id: qemu
        uses: tobozo/esp32-qemu-sim@v2.1.0
        with:
          flash-image: qemu-build/merged.bin  # Single file!
          chip: ${{ steps.chip.outputs.chip }}
          qemu-timeout: "120"
          timeout-interrupt-regex: "Test finished.*completed.*iterations|Starting loop iteration 2"
          debug: true

      - name: Display QEMU output
        if: always()
        run: |
          echo "=== QEMU Results ==="
          echo "Conclusion: ${{ steps.qemu.conclusion }}"
          echo "Outcome: ${{ steps.qemu.outcome }}"

          if [ -f logs.txt ]; then
            echo "=== QEMU Output (first 100 lines) ==="
            head -100 logs.txt

            echo "=== Output Summary ==="
            echo "Total lines: $(wc -l < logs.txt)"
            echo "Boot messages: $(grep -c 'rst:' logs.txt || echo 0)"
            echo "Setup messages: $(grep -c 'setup starting' logs.txt || echo 0)"
            echo "Loop iterations: $(grep -c 'Starting loop iteration' logs.txt || echo 0)"
          fi

      - name: Validate output
        run: |
          echo "=== Validating ${{ matrix.sketch }} output ==="

          if [ ! -f logs.txt ]; then
            echo "❌ No QEMU output found"
            exit 1
          fi

          # Check for crash patterns
          if grep -q "guru meditation\|abort()" logs.txt; then
            echo "❌ QEMU crashed!"
            grep -A 10 "guru meditation\|abort()" logs.txt
            exit 1
          fi

          # Check for expected output
          if grep -q "${{ matrix.sketch }} setup starting" logs.txt; then
            echo "✅ Setup message found"
          else
            echo "❌ Setup message not found"
            exit 1
          fi

          echo "=== Validation complete ==="

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-failure-${{ matrix.platform }}-${{ matrix.sketch }}-${{ github.sha }}
          path: |
            logs.txt
            qemu-build/
          include-hidden-files: true

      - name: Upload logs on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-success-${{ matrix.platform }}-${{ matrix.sketch }}-${{ github.sha }}
          path: logs.txt

      - name: Summary
        if: always()
        run: |
          echo "=== Test Summary ==="
          echo "Platform: ${{ matrix.platform }}"
          echo "Sketch: ${{ matrix.sketch }}"
          echo "Status: ${{ job.status }}"

          if [ -f logs.txt ]; then
            echo "QEMU output lines: $(wc -l < logs.txt)"
          fi
